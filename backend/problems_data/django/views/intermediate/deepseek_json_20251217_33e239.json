{
  "problem_id": "django-views-012",
  "title": "Implement Multi-Step Employee Onboarding Wizard",
  "slug": "implement-multi-step-employee-onboarding-wizard",
  "framework": "django",
  "category": "views",
  "difficulty": "intermediate",
  "description": "You're building an employee onboarding system that guides new hires through a multi-step process. The wizard must save progress between steps, validate data at each stage, and handle file uploads.\n\n**Process Steps:**\n\n1. **Personal Information**\n   - Name, email, phone, address\n   - Emergency contact details\n   - Government IDs (SSN, passport)\n\n2. **Employment Details**\n   - Job title, department, start date\n   - Salary information\n   - Work location (office/remote/hybrid)\n\n3. **Document Upload**\n   - Resume/CV (PDF/DOC)\n   - ID verification (scanned copy)\n   - Signed offer letter\n   - Bank details for payroll\n\n4. **Equipment & Setup**\n   - Computer preferences\n   - Software requirements\n   - Office equipment needs\n   - Shipping address for equipment\n\n5. **Review & Submit**\n   - Review all entered information\n   - Make corrections if needed\n   - Final submission with digital signature\n\n**Requirements:**\n\n1. **View Structure:**\n   - Use Django's FormView for each step\n   - Implement a wizard pattern using sessions\n   - Handle navigation (next, previous, save & exit)\n\n2. **Session Management:**\n   - Store form data between steps in session\n   - Handle session expiration gracefully\n   - Allow users to resume where they left off\n   - Clear session data after successful submission\n\n3. **Form Validation:**\n   - Validate each step independently\n   - Cross-step validation (e.g., work location affects shipping address)\n   - File validation (size, type, virus scanning simulation)\n\n4. **File Handling:**\n   - Upload files to secure location\n   - Generate unique filenames\n   - Store file metadata in database\n   - Handle large file uploads\n\n5. **Progress Tracking:**\n   - Show progress bar\n   - Track time spent on each step\n   - Save draft automatically every 2 minutes\n   - Send email notifications for incomplete applications\n\n6. **Security:**\n   - CSRF protection\n   - Secure file upload validation\n   - Encrypt sensitive data in session\n   - Rate limiting to prevent brute force\n\n**Models Needed:**\n```python\nclass OnboardingApplication(models.Model):\n    STATUS_CHOICES = [\n        ('draft', 'Draft'),\n        ('submitted', 'Submitted'),\n        ('reviewing', 'Under Review'),\n        ('approved', 'Approved'),\n        ('rejected', 'Rejected'),\n    ]\n    \n    applicant = models.ForeignKey(User, on_delete=models.CASCADE, related_name='onboarding_applications')\n    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='draft')\n    started_at = models.DateTimeField(auto_now_add=True)\n    last_updated = models.DateTimeField(auto_now=True)\n    submitted_at = models.DateTimeField(null=True, blank=True)\n    application_data = models.JSONField(default=dict)  # Store all form data\n    tracking_id = models.CharField(max_length=50, unique=True)\n\nclass OnboardingDocument(models.Model):\n    application = models.ForeignKey(OnboardingApplication, on_delete=models.CASCADE, related_name='documents')\n    document_type = models.CharField(max_length=50, choices=[\n        ('resume', 'Resume/CV'),\n        ('id_verification', 'ID Verification'),\n        ('offer_letter', 'Offer Letter'),\n        ('bank_details', 'Bank Details'),\n        ('other', 'Other')\n    ])\n    file = models.FileField(upload_to='onboarding/%Y/%m/%d/')\n    original_filename = models.CharField(max_length=255)\n    file_size = models.IntegerField()\n    uploaded_at = models.DateTimeField(auto_now_add=True)\n    verified = models.BooleanField(default=False)\n\nclass ApplicationProgress(models.Model):\n    application = models.OneToOneField(OnboardingApplication, on_delete=models.CASCADE, related_name='progress')\n    current_step = models.IntegerField(default=1)\n    steps_completed = models.JSONField(default=list)  # List of completed step numbers\n    time_spent = models.JSONField(default=dict)  # {step: seconds_spent}\n    last_activity = models.DateTimeField(auto_now=True)\n```\n\n**Expected Behavior:**\n- User starts onboarding, gets a tracking ID\n- Progress saved automatically between steps\n- Can navigate back to previous steps\n- Files uploaded are validated and stored securely\n- Final submission sends notification to HR\n- User can view their application status\n\n**Error Handling:**\n- Session timeout redirects to resume page\n- Invalid file uploads show clear error messages\n- Validation errors shown inline with forms\n- Graceful handling of concurrent edits",
  "description_preview": "Create a multi-step wizard view with session management, file uploads, progress tracking, and automatic draft saving.",
  "context_code": "# MODELS (for reference only)\n# These models are already defined\nfrom django.db import models\nfrom django.contrib.auth.models import User\n\n# Models defined as above\n# You need to create the wizard views, forms, and session management",
  "starter_code": "",
  "target_area": "Create the multi-step wizard views, session management system, file handling, and progress tracking",
  "validation_spec": {
    "required_imports": [
      "django.views.generic",
      "django.views.generic.edit",
      "django.core.files.storage",
      "django.core.files.uploadedfile",
      "django.contrib.sessions",
      "django.utils.crypto",
      "json",
      "datetime"
    ],
    "required_structure": {
      "classes": [
        {
          "name": "OnboardingWizardView",
          "parent_class": "FormView",
          "required_methods": ["get_form_class", "form_valid", "get_context_data", "get_success_url"]
        },
        {
          "name": "SessionStorage",
          "required_methods": ["get_data", "set_data", "clear_data", "has_data", "get_step_data"]
        },
        {
          "name": "PersonalInfoForm",
          "parent_class": "forms.Form",
          "required_fields": ["full_name", "email", "phone", "address", "emergency_contact"]
        },
        {
          "name": "EmploymentForm",
          "parent_class": "forms.Form",
          "required_fields": ["job_title", "department", "start_date", "salary", "work_location"]
        },
        {
          "name": "DocumentUploadForm",
          "parent_class": "forms.Form",
          "required_fields": ["resume", "id_verification", "offer_letter", "bank_details"],
          "required_methods": ["clean", "save"]
        },
        {
          "name": "ProgressTracker",
          "required_methods": ["update_progress", "get_progress", "save_draft", "calculate_time_spent"]
        }
      ],
      "functions": [
        {
          "name": "generate_tracking_id",
          "params": [],
          "returns": "str"
        },
        {
          "name": "validate_file_upload",
          "params": ["uploaded_file", "allowed_types", "max_size"],
          "returns": "bool"
        }
      ]
    },
    "behavior_patterns": [
      "Uses Django's session framework for storing wizard data",
      "Implements step navigation (next, previous, jump)",
      "Validates each form step independently",
      "Handles file uploads with size and type validation",
      "Saves progress automatically with AJAX",
      "Generates unique tracking IDs for applications",
      "Shows progress bar with completed steps",
      "Handles session expiration gracefully",
      "Encrypts sensitive data in session",
      "Saves drafts to database periodically",
      "Sends email notifications on submission",
      "Provides resume functionality for incomplete applications",
      "Validates cross-step dependencies",
      "Uses atomic transactions for final submission",
      "Implements CSRF protection for all forms"
    ]
  },
  "import_weight": 15.00,
  "structure_weight": 35.00,
  "behavior_weight": 50.00,
  "passing_score": 80.00,
  "hints": [
    "Use Django's FormView as base class for each step",
    "Store wizard data in session with a unique key",
    "Implement a custom session storage class for encryption",
    "Use Django's FileField and forms.FileField for uploads",
    "Generate tracking ID using uuid or timestamp + random string",
    "Override get_form_class() to return different forms based on step",
    "Use AJAX for auto-saving drafts without page reload",
    "Implement a middleware for session timeout handling",
    "Use Django's messages framework for user feedback",
    "Consider using django-formtools for built-in wizard functionality"
  ],
  "learning_resources": [
    "https://docs.djangoproject.com/en/stable/topics/forms/",
    "https://docs.djangoproject.com/en/stable/topics/http/sessions/",
    "https://docs.djangoproject.com/en/stable/topics/http/file-uploads/",
    "https://django-formtools.readthedocs.io/en/latest/wizard.html"
  ],
  "tags": ["django", "views", "formview", "wizard", "session", "file_upload", "intermediate"],
  "estimated_time_minutes": 50,
  "patterns": [
    {
      "pattern_id": "django-views-012-pattern-1",
      "name": "Multi-Step Wizard with Session Management",
      "description": "Complete implementation of onboarding wizard with session storage, file uploads, and progress tracking",
      "example_code": "import json\nimport uuid\nfrom datetime import datetime, timedelta\nfrom typing import Dict, List, Optional, Any\n\nfrom django import forms\nfrom django.conf import settings\nfrom django.core.files.storage import FileSystemStorage\nfrom django.core.files.uploadedfile import UploadedFile\nfrom django.db import transaction\nfrom django.http import JsonResponse\nfrom django.shortcuts import redirect, render\nfrom django.urls import reverse_lazy\nfrom django.utils import timezone\nfrom django.utils.crypto import get_random_string\nfrom django.utils.decorators import method_decorator\nfrom django.views.decorators.csrf import csrf_exempt, ensure_csrf_cookie\nfrom django.views.generic import FormView, TemplateView, View\nfrom django.views.generic.edit import ProcessFormView\n\nfrom .models import OnboardingApplication, OnboardingDocument, ApplicationProgress\n\n\nclass SessionStorage:\n    \"\"\"Encrypted session storage for wizard data\"\"\"\n    \n    SESSION_KEY = 'onboarding_wizard_data'\n    \n    def __init__(self, request):\n        self.request = request\n        \n    def get_data(self) -> Dict:\n        \"\"\"Get all wizard data from session\"\"\"\n        data = self.request.session.get(self.SESSION_KEY, {})\n        return self._decrypt_data(data) if data else {}\n    \n    def set_data(self, data: Dict) -> None:\n        \"\"\"Set wizard data in session\"\"\"\n        encrypted_data = self._encrypt_data(data)\n        self.request.session[self.SESSION_KEY] = encrypted_data\n        self.request.session.modified = True\n    \n    def clear_data(self) -> None:\n        \"\"\"Clear wizard data from session\"\"\"\n        if self.SESSION_KEY in self.request.session:\n            del self.request.session[self.SESSION_KEY]\n    \n    def has_data(self) -> bool:\n        \"\"\"Check if wizard data exists in session\"\"\"\n        return self.SESSION_KEY in self.request.session\n    \n    def get_step_data(self, step: int) -> Dict:\n        \"\"\"Get data for specific step\"\"\"\n        data = self.get_data()\n        return data.get(f'step_{step}', {})\n    \n    def set_step_data(self, step: int, step_data: Dict) -> None:\n        \"\"\"Set data for specific step\"\"\"\n        data = self.get_data()\n        data[f'step_{step}'] = step_data\n        self.set_data(data)\n    \n    def _encrypt_data(self, data: Dict) -> Dict:\n        \"\"\"Encrypt sensitive data (simplified - use proper encryption in production)\"\"\"\n        # In production, use cryptography.fernet or similar\n        # For this example, we'll just store as-is with a flag\n        return {\n            'data': data,\n            'encrypted': False,  # Set to True when using real encryption\n            'timestamp': timezone.now().isoformat()\n        }\n    \n    def _decrypt_data(self, encrypted_data: Dict) -> Dict:\n        \"\"\"Decrypt data\"\"\"\n        if encrypted_data.get('encrypted', False):\n            # Implement decryption here\n            pass\n        return encrypted_data.get('data', {})\n\n\nclass ProgressTracker:\n    \"\"\"Track wizard progress\"\"\"\n    \n    def __init__(self, request, tracking_id=None):\n        self.request = request\n        self.tracking_id = tracking_id\n        self.session_storage = SessionStorage(request)\n    \n    def update_progress(self, step: int, completed: bool = True) -> None:\n        \"\"\"Update progress for current step\"\"\"\n        data = self.session_storage.get_data()\n        \n        # Initialize progress if not exists\n        if 'progress' not in data:\n            data['progress'] = {\n                'current_step': step,\n                'steps_completed': [],\n                'time_spent': {},\n                'started_at': timezone.now().isoformat()\n            }\n        \n        progress = data['progress']\n        progress['current_step'] = step\n        \n        if completed and step not in progress['steps_completed']:\n            progress['steps_completed'].append(step)\n            \n        # Update time spent (simplified)\n        progress['time_spent'][str(step)] = progress['time_spent'].get(str(step), 0) + 1\n        \n        data['progress'] = progress\n        self.session_storage.set_data(data)\n    \n    def get_progress(self) -> Dict:\n        \"\"\"Get current progress\"\"\"\n        data = self.session_storage.get_data()\n        return data.get('progress', {\n            'current_step': 1,\n            'steps_completed': [],\n            'time_spent': {},\n            'started_at': timezone.now().isoformat()\n        })\n    \n    def save_draft(self) -> Optional[str]:\n        \"\"\"Save current state as draft in database\"\"\"\n        data = self.session_storage.get_data()\n        \n        if not data or 'tracking_id' not in data:\n            return None\n        \n        tracking_id = data['tracking_id']\n        \n        with transaction.atomic():\n            # Get or create application\n            application, created = OnboardingApplication.objects.get_or_create(\n                tracking_id=tracking_id,\n                defaults={\n                    'applicant': self.request.user,\n                    'status': 'draft',\n                    'application_data': data\n                }\n            )\n            \n            if not created:\n                application.application_data = data\n                application.save()\n            \n            # Update progress\n            progress_data = self.get_progress()\n            progress, _ = ApplicationProgress.objects.update_or_create(\n                application=application,\n                defaults={\n                    'current_step': progress_data.get('current_step', 1),\n                    'steps_completed': progress_data.get('steps_completed', []),\n                    'time_spent': progress_data.get('time_spent', {}),\n                    'last_activity': timezone.now()\n                }\n            )\n            \n            return tracking_id\n    \n    def calculate_completion_percentage(self) -> int:\n        \"\"\"Calculate completion percentage\"\"\"\n        progress = self.get_progress()\n        total_steps = 5  # Fixed for this wizard\n        completed = len(progress.get('steps_completed', []))\n        \n        return int((completed / total_steps) * 100) if total_steps > 0 else 0\n\n\nclass PersonalInfoForm(forms.Form):\n    \"\"\"Step 1: Personal Information\"\"\"\n    \n    full_name = forms.CharField(max_length=200, required=True)\n    email = forms.EmailField(required=True)\n    phone = forms.CharField(max_length=20, required=True)\n    address = forms.CharField(widget=forms.Textarea, required=True)\n    emergency_contact_name = forms.CharField(max_length=200, required=True)\n    emergency_contact_phone = forms.CharField(max_length=20, required=True)\n    emergency_contact_relationship = forms.CharField(max_length=100, required=True)\n    ssn = forms.CharField(max_length=11, required=False)  # US Social Security Number\n    passport_number = forms.CharField(max_length=50, required=False)\n    \n    def clean_ssn(self):\n        \"\"\"Validate SSN format\"\"\"\n        ssn = self.cleaned_data.get('ssn')\n        if ssn:\n            # Simple validation - in production use more robust validation\n            if not ssn.replace('-', '').isdigit():\n                raise forms.ValidationError(\"Enter a valid SSN in format XXX-XX-XXXX\")\n        return ssn\n    \n    def clean(self):\n        \"\"\"Validate that at least one ID is provided\"\"\"\n        cleaned_data = super().clean()\n        ssn = cleaned_data.get('ssn')\n        passport = cleaned_data.get('passport_number')\n        \n        if not ssn and not passport:\n            raise forms.ValidationError(\n                \"Please provide either SSN or Passport Number for identification\"\n            )\n        \n        return cleaned_data\n\n\nclass EmploymentForm(forms.Form):\n    \"\"\"Step 2: Employment Details\"\"\"\n    \n    job_title = forms.CharField(max_length=100, required=True)\n    department = forms.ChoiceField(\n        choices=[\n            ('engineering', 'Engineering'),\n            ('sales', 'Sales'),\n            ('marketing', 'Marketing'),\n            ('hr', 'Human Resources'),\n            ('finance', 'Finance'),\n            ('operations', 'Operations')\n        ],\n        required=True\n    )\n    start_date = forms.DateField(required=True, widget=forms.DateInput(attrs={'type': 'date'}))\n    salary = forms.DecimalField(max_digits=10, decimal_places=2, required=True)\n    work_location = forms.ChoiceField(\n        choices=[\n            ('office', 'Office'),\n            ('remote', 'Remote'),\n            ('hybrid', 'Hybrid')\n        ],\n        required=True\n    )\n    office_location = forms.CharField(max_length=200, required=False)\n    remote_address = forms.CharField(widget=forms.Textarea, required=False)\n    \n    def clean(self):\n        \"\"\"Validate work location specific fields\"\"\"\n        cleaned_data = super().clean()\n        work_location = cleaned_data.get('work_location')\n        office_location = cleaned_data.get('office_location')\n        remote_address = cleaned_data.get('remote_address')\n        \n        if work_location == 'office' and not office_location:\n            self.add_error('office_location', 'Office location is required for office work')\n        elif work_location == 'remote' and not remote_address:\n            self.add_error('remote_address', 'Remote work address is required')\n        elif work_location == 'hybrid' and (not office_location or not remote_address):\n            self.add_error('office_location', 'Both office location and remote address are required for hybrid work')\n            self.add_error('remote_address', 'Both office location and remote address are required for hybrid work')\n        \n        return cleaned_data\n\n\nclass DocumentUploadForm(forms.Form):\n    \"\"\"Step 3: Document Upload\"\"\"\n    \n    MAX_FILE_SIZE = 10 * 1024 * 1024  # 10MB\n    ALLOWED_TYPES = ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png']\n    \n    resume = forms.FileField(required=True)\n    id_verification = forms.FileField(required=True)\n    offer_letter = forms.FileField(required=True)\n    bank_details = forms.FileField(required=True)\n    \n    def clean_resume(self):\n        return self._validate_file(self.cleaned_data.get('resume'), 'resume')\n    \n    def clean_id_verification(self):\n        return self._validate_file(self.cleaned_data.get('id_verification'), 'id_verification')\n    \n    def clean_offer_letter(self):\n        return self._validate_file(self.cleaned_data.get('offer_letter'), 'offer_letter')\n    \n    def clean_bank_details(self):\n        return self._validate_file(self.cleaned_data.get('bank_details'), 'bank_details')\n    \n    def _validate_file(self, uploaded_file: UploadedFile, field_name: str) -> UploadedFile:\n        \"\"\"Validate uploaded file\"\"\"\n        if not uploaded_file:\n            raise forms.ValidationError(f\"{field_name.replace('_', ' ').title()} is required\")\n        \n        # Check file size\n        if uploaded_file.size > self.MAX_FILE_SIZE:\n            raise forms.ValidationError(\n                f\"File size must not exceed {self.MAX_FILE_SIZE / (1024*1024)}MB\"\n            )\n        \n        # Check file type\n        ext = uploaded_file.name.split('.')[-1].lower()\n        if ext not in self.ALLOWED_TYPES:\n            raise forms.ValidationError(\n                f\"File type not allowed. Allowed types: {', '.join(self.ALLOWED_TYPES)}\"\n            )\n        \n        return uploaded_file\n\n\nclass EquipmentForm(forms.Form):\n    \"\"\"Step 4: Equipment & Setup\"\"\"\n    \n    computer_type = forms.ChoiceField(\n        choices=[\n            ('laptop', 'Laptop'),\n            ('desktop', 'Desktop'),\n            ('both', 'Both Laptop and Desktop')\n        ],\n        required=True\n    )\n    os_preference = forms.ChoiceField(\n        choices=[\n            ('windows', 'Windows'),\n            ('macos', 'macOS'),\n            ('linux', 'Linux'),\n            ('no_preference', 'No Preference')\n        ],\n        required=True\n    )\n    software_requirements = forms.CharField(\n        widget=forms.Textarea,\n        required=False,\n        help_text=\"List any specific software you need\"\n    )\n    office_equipment = forms.MultipleChoiceField(\n        choices=[\n            ('monitor', 'Additional Monitor'),\n            ('keyboard', 'External Keyboard'),\n            ('mouse', 'External Mouse'),\n            ('dock', 'Docking Station'),\n            ('headset', 'Headset'),\n            ('webcam', 'Webcam')\n        ],\n        widget=forms.CheckboxSelectMultiple,\n        required=False\n    )\n    shipping_address = forms.CharField(widget=forms.Textarea, required=True)\n    shipping_instructions = forms.CharField(widget=forms.Textarea, required=False)\n\n\nclass ReviewForm(forms.Form):\n    \"\"\"Step 5: Review & Submit\"\"\"\n    \n    digital_signature = forms.CharField(max_length=200, required=True)\n    agree_terms = forms.BooleanField(required=True)\n    \n    def clean_digital_signature(self):\n        signature = self.cleaned_data.get('digital_signature')\n        if signature != self.request.user.get_full_name():\n            raise forms.ValidationError(\"Digital signature must match your full name\")\n        return signature\n\n\nclass OnboardingWizardView(ProcessFormView):\n    \"\"\"Main wizard view\"\"\"\n    \n    template_name = 'onboarding/wizard.html'\n    success_url = reverse_lazy('onboarding_success')\n    \n    # Define steps\n    STEPS = [\n        ('personal', 'Personal Information', PersonalInfoForm),\n        ('employment', 'Employment Details', EmploymentForm),\n        ('documents', 'Document Upload', DocumentUploadForm),\n        ('equipment', 'Equipment & Setup', EquipmentForm),\n        ('review', 'Review & Submit', ReviewForm)\n    ]\n    \n    def __init__(self, *args, **kwargs):\n        super().__init__(*args, **kwargs)\n        self.session_storage = None\n        self.progress_tracker = None\n        self.tracking_id = None\n    \n    def dispatch(self, request, *args, **kwargs):\n        \"\"\"Initialize session storage and progress tracker\"\"\"\n        self.session_storage = SessionStorage(request)\n        \n        # Get or create tracking ID\n        data = self.session_storage.get_data()\n        if 'tracking_id' not in data:\n            data['tracking_id'] = self.generate_tracking_id()\n            self.session_storage.set_data(data)\n        \n        self.tracking_id = data['tracking_id']\n        self.progress_tracker = ProgressTracker(request, self.tracking_id)\n        \n        return super().dispatch(request, *args, **kwargs)\n    \n    def get(self, request, *args, **kwargs):\n        \"\"\"Handle GET request - show current step\"\"\"\n        step = self.get_step()\n        return self.render_step(step)\n    \n    def post(self, request, *args, **kwargs):\n        \"\"\"Handle POST request - process form\"\"\"\n        step = self.get_step()\n        form_class = self.get_form_class_for_step(step)\n        form = form_class(request.POST, request.FILES)\n        \n        if form.is_valid():\n            return self.process_valid_form(step, form)\n        else:\n            return self.render_step(step, form)\n    \n    def get_step(self) -> int:\n        \"\"\"Get current step from request or progress\"\"\"\n        step_param = self.request.GET.get('step') or self.request.POST.get('step')\n        if step_param and step_param.isdigit():\n            return int(step_param)\n        \n        # Get from progress\n        progress = self.progress_tracker.get_progress()\n        return progress.get('current_step', 1)\n    \n    def get_form_class_for_step(self, step: int):\n        \"\"\"Get form class for specific step\"\"\"\n        if 1 <= step <= len(self.STEPS):\n            return self.STEPS[step - 1][2]\n        return self.STEPS[0][2]  # Default to first form\n    \n    def render_step(self, step: int, form=None):\n        \"\"\"Render step with form\"\"\"\n        if form is None:\n            form_class = self.get_form_class_for_step(step)\n            \n            # Pre-populate with saved data\n            saved_data = self.session_storage.get_step_data(step)\n            form = form_class(initial=saved_data)\n        \n        # Update progress\n        self.progress_tracker.update_progress(step, completed=False)\n        \n        context = self.get_context_data(\n            step=step,\n            form=form,\n            steps=self.STEPS,\n            progress_percentage=self.progress_tracker.calculate_completion_percentage(),\n            saved_data=self.session_storage.get_data()\n        )\n        \n        return render(self.request, self.template_name, context)\n    \n    def process_valid_form(self, step: int, form):\n        \"\"\"Process valid form submission\"\"\"\n        # Save form data to session\n        form_data = form.cleaned_data\n        \n        # Handle file uploads for document step\n        if step == 3:  # Document upload step\n            form_data = self.handle_file_uploads(form)\n        \n        self.session_storage.set_step_data(step, form_data)\n        \n        # Update progress\n        self.progress_tracker.update_progress(step, completed=True)\n        \n        # Save draft\n        self.progress_tracker.save_draft()\n        \n        # Determine next action\n        action = self.request.POST.get('action', 'next')\n        \n        if action == 'previous' and step > 1:\n            return redirect(f'{self.request.path}?step={step-1}')\n        elif action == 'save_exit':\n            return redirect('onboarding_resume')\n        elif action == 'submit' and step == len(self.STEPS):\n            return self.final_submission()\n        elif step < len(self.STEPS):\n            return redirect(f'{self.request.path}?step={step+1}')\n        else:\n            return redirect(f'{self.request.path}?step={step}')\n    \n    def handle_file_uploads(self, form) -> Dict:\n        \"\"\"Handle file uploads and save to storage\"\"\"\n        file_data = {}\n        \n        for field_name in ['resume', 'id_verification', 'offer_letter', 'bank_details']:\n            uploaded_file = form.cleaned_data.get(field_name)\n            if uploaded_file:\n                # Generate unique filename\n                original_name = uploaded_file.name\n                ext = original_name.split('.')[-1]\n                unique_name = f\"{uuid.uuid4()}.{ext}\"\n                \n                # Save file\n                fs = FileSystemStorage(location=settings.MEDIA_ROOT / 'onboarding')\n                filename = fs.save(unique_name, uploaded_file)\n                \n                # Store file metadata\n                file_data[field_name] = {\n                    'filename': filename,\n                    'original_name': original_name,\n                    'size': uploaded_file.size,\n                    'path': fs.path(filename)\n                }\n        \n        return file_data\n    \n    def final_submission(self):\n        \"\"\"Handle final submission\"\"\"\n        with transaction.atomic():\n            # Get all data\n            data = self.session_storage.get_data()\n            \n            # Create final application\n            application = OnboardingApplication.objects.create(\n                tracking_id=self.tracking_id,\n                applicant=self.request.user,\n                status='submitted',\n                application_data=data,\n                submitted_at=timezone.now()\n            )\n            \n            # Save uploaded documents to database\n            if 'step_3' in data:\n                file_data = data['step_3']\n                for field_name, file_info in file_data.items():\n                    if isinstance(file_info, dict):\n                        OnboardingDocument.objects.create(\n                            application=application,\n                            document_type=field_name,\n                            file=file_info['filename'],\n                            original_filename=file_info['original_name'],\n                            file_size=file_info['size']\n                        )\n            \n            # Clear session data\n            self.session_storage.clear_data()\n            \n            # Send notification email\n            self.send_submission_email(application)\n            \n            return redirect(self.success_url)\n    \n    def send_submission_email(self, application):\n        \"\"\"Send submission confirmation email\"\"\"\n        # Implementation for email sending\n        # Use Django's send_mail or Celery for async\n        pass\n    \n    def generate_tracking_id(self) -> str:\n        \"\"\"Generate unique tracking ID\"\"\"\n        timestamp = datetime.now().strftime('%Y%m%d%H%M%S')\n        random_str = get_random_string(6, 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789')\n        return f\"ONB-{timestamp}-{random_str}\"\n    \n    def get_context_data(self, **kwargs):\n        \"\"\"Get template context\"\"\"\n        context = super().get_context_data(**kwargs)\n        context['tracking_id'] = self.tracking_id\n        return context\n\n\nclass AutoSaveView(View):\n    \"\"\"AJAX view for auto-saving drafts\"\"\"\n    \n    @method_decorator(csrf_exempt)\n    @method_decorator(ensure_csrf_cookie)\n    def post(self, request, *args, **kwargs):\n        \"\"\"Handle auto-save request\"\"\"\n        if not request.user.is_authenticated:\n            return JsonResponse({'success': False, 'error': 'Authentication required'})\n        \n        tracker = ProgressTracker(request)\n        tracking_id = tracker.save_draft()\n        \n        if tracking_id:\n            return JsonResponse({\n                'success': True,\n                'tracking_id': tracking_id,\n                'timestamp': timezone.now().isoformat()\n            })\n        else:\n            return JsonResponse({'success': False, 'error': 'Save failed'})\n\n\nclass ResumeOnboardingView(TemplateView):\n    \"\"\"View to resume incomplete onboarding\"\"\"\n    \n    template_name = 'onboarding/resume.html'\n    \n    def get_context_data(self, **kwargs):\n        context = super().get_context_data(**kwargs)\n        \n        # Get user's draft applications\n        drafts = OnboardingApplication.objects.filter(\n            applicant=self.request.user,\n            status='draft'\n        ).order_by('-last_updated')\n        \n        context['drafts'] = drafts\n        return context\n    \n    def post(self, request, *args, **kwargs):\n        \"\"\"Resume a specific draft\"\"\"\n        tracking_id = request.POST.get('tracking_id')\n        \n        try:\n            draft = OnboardingApplication.objects.get(\n                tracking_id=tracking_id,\n                applicant=request.user,\n                status='draft'\n            )\n            \n            # Load data into session\n            session_storage = SessionStorage(request)\n            session_storage.set_data(draft.application_data)\n            \n            # Redirect to wizard\n            return redirect('onboarding_wizard')\n            \n        except OnboardingApplication.DoesNotExist:\n            return redirect('onboarding_start')",
      "required_imports": [
        "django.views.generic",
        "django.views.generic.edit",
        "django.core.files.storage",
        "django.core.files.uploadedfile",
        "django.db.transaction",
        "django.utils.timezone",
        "django.utils.crypto",
        "json",
        "uuid",
        "datetime"
      ],
      "required_structure": {
        "classes": [
          {
            "name": "SessionStorage",
            "required_methods": ["get_data", "set_data", "clear_data", "has_data", "get_step_data", "set_step_data"]
          },
          {
            "name": "ProgressTracker",
            "required_methods": ["update_progress", "get_progress", "save_draft", "calculate_completion_percentage"]
          },
          {
            "name": "OnboardingWizardView",
            "parent_class": "ProcessFormView",
            "required_methods": ["get_step", "get_form_class_for_step", "render_step", "process_valid_form", "final_submission", "generate_tracking_id"]
          },
          {
            "name": "AutoSaveView",
            "parent_class": "View",
            "required_methods": ["post"]
          }
        ],
        "functions": [
          {
            "name": "validate_file_upload",
            "params": ["uploaded_file", "allowed_types", "max_size"],
            "returns": "bool"
          }
        ]
      },
      "forbidden_patterns": [
        "Not using sessions for wizard state",
        "No file validation for uploads",
        "Storing files with original filenames",
        "No progress tracking between steps",
        "No auto-save functionality",
        "Not handling session expiration",
        "No resume functionality for incomplete applications",
        "Storing sensitive data in plain text in session",
        "No CSRF protection for forms",
        "Not using atomic transactions for final submission"
      ],
      "is_primary": true,
      "confidence_threshold": 85.00
    }
  ]
}